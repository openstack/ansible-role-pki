---
# Copyright 2025, Cleura AB.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- name: Prepare openbao server
  hosts: pki-hashi-vault-main
  vars:
    openbao_root_token: "secret-root-token"
  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      when:
        - ansible_facts['os_family'] | lower == 'debian'

    - name: Enable EPEL repository
      package:
        name: epel-release
        state: present
      when: ansible_facts['os_family'] | lower == 'redhat'

    - name: Install packages
      ansible.builtin.package:
        name: "{{ molecule_packages[ansible_facts['os_family'] | lower] }}"

    - name: Wait for OpenBao to become available
      ansible.builtin.wait_for:
        port: 8200
        host: pki-hashi-vault-openbao
        delay: 5
        timeout: 20

    - name: Set environment variables in /etc/environment
      ansible.builtin.lineinfile:
        path: "/etc/environment"
        line: "{{ item }}"
        create: yes
      loop:
        - 'BAO_ADDR="{{ pki_hashi_vault_host }}"'
        - 'BAO_TOKEN="{{ openbao_root_token }}"'
      no_log: true

    - name: Create pki policy
      community.hashi_vault.vault_write:
        path: sys/policies/acl/pki
        url: "{{ pki_hashi_vault_host }}"
        token: "{{ openbao_root_token }}"
        data:
          policy: |
            path "pki_root/*" {
              capabilities = ["create", "read", "update", "delete", "list", "sudo"]
            }
            path "pki_int/*" {
              capabilities = ["create", "read", "update", "delete", "list", "sudo"]
            }

    - name: Enable userpass authentication method
      community.hashi_vault.vault_write:
        path: sys/auth/userpass
        url: "{{ pki_hashi_vault_host }}"
        token: "{{ openbao_root_token }}"
        data:
          type: userpass

    - name: Create OpenBao user
      community.hashi_vault.vault_write:
        path: auth/userpass/users/{{ pki_hashi_vault_login | default('osa') }}
        url: "{{ pki_hashi_vault_host }}"
        token: "{{ openbao_root_token }}"
        data:
          password: "{{ pki_hashi_vault_password }}"
          policies: "pki"

    - name: Enable PKI secret engine at pki_root/
      community.hashi_vault.vault_write:
        path: sys/mounts/pki_root
        url: "{{ pki_hashi_vault_host }}"
        token: "{{ openbao_root_token }}"
        data:
          type: pki
          config:
            max_lease_ttl: 3650d

    - name: Enable PKI secret engine at pki_int/
      community.hashi_vault.vault_write:
        path: sys/mounts/pki_int
        url: "{{ pki_hashi_vault_host }}"
        token: "{{ openbao_root_token }}"
        data:
          type: pki
          config:
            max_lease_ttl: 3650d

    - name: Create role in pki_int/
      community.hashi_vault.vault_write:
        path: pki_int/roles/{{ pki_hashi_vault_role }}
        url: "{{ pki_hashi_vault_host }}"
        token: "{{ openbao_root_token }}"
        data:
          allow_any_name: true
          ttl: 90d
